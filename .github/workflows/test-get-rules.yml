name: Test get-rules Skill

on:
  push:
    branches: [main, develop]
    paths:
      - 'skills/get-rules/**'
      - '.github/workflows/test-get-rules.yml'
  pull_request:
    branches: [main]
    paths:
      - 'skills/get-rules/**'
      - '.github/workflows/test-get-rules.yml'
  workflow_dispatch:  # Allow manual triggering

jobs:
  test-get-rules:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.11']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Verify Python installation
        run: |
          python --version
          python -c "import sys; print(f'Python executable: {sys.executable}')"

      - name: Verify Git installation
        run: git --version

      - name: Test skill execution (without API key)
        run: |
          python skills/get-rules/scripts/fetch-qodo-rules.py
        continue-on-error: true

      - name: Test skill execution (with API key)
        if: ${{ secrets.QODO_API_KEY != '' }}
        env:
          QODO_API_KEY: ${{ secrets.QODO_API_KEY }}
          QODO_ENVIRONMENT_NAME: ${{ secrets.QODO_ENVIRONMENT_NAME }}
        run: |
          python skills/get-rules/scripts/fetch-qodo-rules.py
        continue-on-error: true

      - name: Test repository detection (SSH format)
        run: |
          cd ${{ runner.temp }}
          git init test-ssh
          cd test-ssh
          git remote add origin git@github.com:qodo-ai/qodo-skills.git
          python ${{ github.workspace }}/skills/get-rules/scripts/fetch-qodo-rules.py || echo "Expected: No API key or no rules"

      - name: Test repository detection (HTTPS format)
        run: |
          cd ${{ runner.temp }}
          git init test-https
          cd test-https
          git remote add origin https://github.com/qodo-ai/qodo-skills.git
          python ${{ github.workspace }}/skills/get-rules/scripts/fetch-qodo-rules.py || echo "Expected: No API key or no rules"

      - name: Test repository detection (no .git suffix)
        run: |
          cd ${{ runner.temp }}
          git init test-no-suffix
          cd test-no-suffix
          git remote add origin https://github.com/qodo-ai/qodo-skills
          python ${{ github.workspace }}/skills/get-rules/scripts/fetch-qodo-rules.py || echo "Expected: No API key or no rules"

      - name: Test non-git directory (should exit silently)
        run: |
          cd ${{ runner.temp }}
          mkdir test-non-git
          cd test-non-git
          python ${{ github.workspace }}/skills/get-rules/scripts/fetch-qodo-rules.py
          echo "✓ Script exited gracefully in non-git directory"

      - name: Test cross-platform path handling
        shell: bash
        run: |
          python -c "
          import os
          from pathlib import Path, PurePosixPath

          # Test path handling
          test_path = Path('modules/api/service.py')
          posix_path = PurePosixPath(*test_path.parts[:2])
          print(f'Native path: {test_path}')
          print(f'POSIX path: {posix_path}')
          print('✓ Cross-platform path handling works')
          "

      - name: Test Python SSL certificates
        run: |
          python -c "
          import ssl
          import sys
          try:
              import certifi
              print(f'✓ certifi available: {certifi.where()}')
          except ImportError:
              print('⚠️  certifi not installed')
          print(f'SSL version: {ssl.OPENSSL_VERSION}')
          "

      - name: Summary
        if: always()
        run: |
          echo "==================================="
          echo "Test Summary for ${{ matrix.os }}"
          echo "==================================="
          echo "✅ Python installation verified"
          echo "✅ Git installation verified"
          echo "✅ Script execution tested"
          echo "✅ Repository detection tested"
          echo "✅ Path handling tested"
          echo "✅ SSL configuration checked"
          echo "==================================="

  test-with-rules:
    name: Test with live API (if configured)
    runs-on: ubuntu-latest
    if: ${{ secrets.QODO_API_KEY != '' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install certifi for SSL
        run: pip install certifi

      - name: Fetch rules from qodo-platform (if accessible)
        env:
          QODO_API_KEY: ${{ secrets.QODO_API_KEY }}
          QODO_ENVIRONMENT_NAME: ${{ secrets.QODO_ENVIRONMENT_NAME }}
        run: |
          cd ${{ runner.temp }}
          git clone --depth 1 https://github.com/Codium-ai/qodo-platform.git || true
          if [ -d qodo-platform ]; then
            cd qodo-platform
            python ${{ github.workspace }}/skills/get-rules/scripts/fetch-qodo-rules.py
          else
            echo "Could not clone qodo-platform (may be private)"
          fi
        continue-on-error: true
